# Deadlock

**교착 상태(Deadlock)**는 프로세스 집합에서 각각의 프로세스가 집합 내의 다른 프로세스만이 발생시킬 수 있는 이벤트를 기다리고 있는 상황이다.



## 데드락의 발생 조건

데드락은 네 가지 조건을 반드시 만족해야 발생한다. 첫번째, 각 자원은 현재 하나의 프로세스에게 할당되어 있거나 가용하다. 상호배제(mutual exclusion)라고 한다. 두번째, 프로세스가 하나 이상의 자원을 잡은 채 다른 자원을 기다린다. 점유 대기(hold and wait)라고 한다. 세번째, 자원을 소유한 프로세스가 해당 자원을 반환할 때까지 빼앗을 수 없다. 비선점(no preemption)이라고 한다. 네번째, 프로세스 집합에서 각자 다른 프로세스들이 소유한 자원을 기다리고 있다. 순환 대기(circular wait)라고 한다.



## 데드락 처리하기

데드락을 처리하는 방법은 세 가지이다. 첫번째, 시스템이 데드락에 빠지지 않도록 예방하거나 회피한다. 두번째, 데드락이 발생하면 이를 감지하고 데드락으로부터 시스템을 복구한다. 세번째, 데드락을 무시한다.



### 데드락 예방

데드락 예방(deadlock prevention)은 데드락 발생 조건 중 하나를 제거하여 데드락의 발생을 방지하는 것이다. 첫번째, 상호배제 조건을 제거해보자. 여러 개의 프로세스가 동일한 자원을 할당받으면 된다. 하지만 어떤 자원(프린터 등)은 프로세스가 공유하는 것이 불가능하다. 또한 경쟁 상태를 피하기 위해서 상호배제를 달성해야한다. 따라서 이 조건은 제거하기 어렵다. 두번째, 점유 대기 조건을 제거해보자. 프로세스가 실행되기 전 필요한 모든 자원을 할당받도록 하거나 어떤 자원도 가지지 않은 상태에서만 자원을 요청할 수 있도록 한다. (새로운 자원을 요청할 때 이미 가지고 있는 자원을 반납하고 해당 자원까지 요청하도록 한다) 그러나 실행 전 필요로 하는 모든 자원을 아는 것은 어렵고, 자원이 효율적으로 사용되지 않는다는 문제가 있다. 자원을 획득할 때까지 프로세스가 기아 상태에 빠질 수 있다. 세번째, 비선점 조건을 제거해보자. 우선순위가 높은 프로세스가 자원을 빼앗을 수 있도록 하면 된다. 네번째, 순환 대기 조건을 제거해보자. 자원에 순서를 할당하여 이전 순서의 자원을 소유해야지만 다음 순서의 자원을 요청할 수 있도록 한다. 가장 많이 사용한다.



### 데드락 회피

데드락 회피는 운영체제가 프로세스 실행 중 데드락이 발생할 수 있는 선택을 피하는 것이다. 프로세스에게 자원을 할당해도 안전한지 확인한 후 자원을 할당한다.

Banker's Algorithm을 사용하여 자원을 할당한 후에도 안전한지 검사할 수 있다. 프로세스가 자원을 요청하면 `(프로세스가 필요로하는 자원의 총량 - 현재 프로세스에게 할당된 자원의 총량)`을 계산하고 `현재 프로세스에게 할당할 수 있는 자원의 총량`과 비교한다. 가용량이 충분하지 않다면 안전한 상태가 아니다.



### 데드락 감지와 회복

데드락 감지는 자원 할당 그래프(RAG; Resource Allocation Graph)를 사용한다. 데드락을 감지하면 데드락이 발생한 프로세스를 모두 죽이거나 하나씩 죽여 순환 대기를 해제한다. 혹은 자원을 선점하도록하여 데드락에서 회복한다. 후자의 경우 자원을 빼앗긴 프로세스가 기아 상태에 빠질 수 있다.



### 데드락 무시

데드락의 발생을 무시한다. 이 경우 시스템을 아예 종료시켜서 해결할 수 있다.



## 참고

- [geeksforgeeks - Introduction of Deadlock in Operating System](https://www.geeksforgeeks.org/introduction-of-deadlock-in-operating-system/?ref=lbp)
- [geeksforgeeks - Deadlock Prevention And Avoidance](https://www.geeksforgeeks.org/deadlock-prevention/?ref=lbp)
- [geeksforgeeks - Deadlock Detection And Recovery](https://www.geeksforgeeks.org/deadlock-detection-recovery/?ref=lbp)
- [데드락(교착상태)은 프로그램에 치명적이죠 T^T 언제 발생하고 어떻게 해결하는지 살펴봅시다~! 간단한 자바 예제도 있어요~!!](https://youtu.be/ESXCSNGFVto)
