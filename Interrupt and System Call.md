# Interrupt and System Call

## 인터럽트란 무엇인가?

**인터럽트(interrupt)**는 특정 이벤트가 발생하여 이것을 처리해야 할 경우 CPU가 현재 수행 중이던 프로그램의 실행을 중단하고 이벤트를 처리하도록 요청하는 것이다. CPU는 현재 수행 중인 명령어를 마치고 다음 명령어를 실행하기 전 인터럽트 라인을 검사하고, 대기 중인 인터럽트를 처리하게 된다.



## 인터럽트의 종류

인터럽트는 인터럽트를 발생하는 주체를 기준으로 **하드웨어 인터럽트**와 **소프트웨어 인터럽트**로 나눌 수 있다.



### 하드웨어 인터럽트

**하드웨어 인터럽트(hardware interrupt)**는 하드웨어(I/O 장치, 타이머 등)에 의해 발생하는 인터럽트이다. 일반적으로 인터럽트는 하드웨어 인터럽트를 가리킨다. 대개 예측 불가능한 이벤트에 의해 발생하므로 비동기식 인터럽트라고 한다.

예) 입출력 인터럽트, 타이머 인터럽트 등



### 소프트웨어 인터럽트

**소프트웨어 인터럽트(software interrupt)**는 소프트웨어(사용자 프로그램)에 의해 발생하는 인터럽트이다. 트랩(trap)이라고도 한다. 대개 명령어 실행에 대한 결과로 발생하므로 동기식 인터럽트라고 한다. 크게 예외 상황과 시스템 콜로 나뉜다.

- 예외 상황: 잘못된 메모리 참조(오버플로우, 언더플로우 등), 0으로 나누기
- 시스템 콜: 운영체제가 제공하는 시스템 서비스를 사용하기 위해 사용자 모드에서 커널 모드로 전환



### 외부/내부, 동기식/비동기식 인터럽트

![실행의 흐름](https://user-images.githubusercontent.com/57662010/209100673-37bde2ea-fb0b-4a76-8084-168b0d465e11.JPG)

- 동기식 인터럽트: 현재 실행 중인 프로그램에서 발생하여(내부에서 발생하여) 발생 시점을 예상할 수 있다.
- 비동기식 인터럽트: 현재 실행 중인 프로그램 외부에서 발생하여 발생 시점을 예상할 수 없다.



## 인터럽트의 발생과 처리 과정

![인터럽트 발생](https://user-images.githubusercontent.com/57662010/209100709-2344118f-a538-4d19-9607-6075d8501a7d.JPG)

1. 하드웨어/소프트웨어가 인터럽트 라인을 설정하여 인터럽트 `A`를 발생시킨다.
2. CPU는 명령어를 수행한 후 다음 명령어를 수행하기 전 인터럽트 라인을 검사한다.
3. 사용자 모드에 있던 CPU는 현재 실행 중이던 프로그램의 상태를 저장하고 커널 모드로 전환한다.
   1. 레지스터의 내용을 스택에 넣는다.
   2. 프로그램 카운터의 내용을 스택에 넣는다.
   3. 스택의 꼭대기를 가리키도록 스택 포인터를 변경한다.
   4. 핸들러의 시작을 가리키도록 프로그램 카운터를 변경한다. 
4. 운영체제는 인터럽트 벡터 테이블(interrupt vector table)에서 인터럽트 `A`를 처리하는 인터럽트 핸들러(interrupt handler)를 찾아 실행하여 인터럽트 `A`를 처리한다.
5. CPU는 저장했던 상태를 복구하고 사용자 모드로 전환하여 기존에 실행 중이던 프로그램을 수행한다.
   1. 스택에 넣었던 프로그램 카운터의 내용을 가져와 프로그램 카운터를 변경한다.
   2. 스택에 넣었던 레지스터의 내용을 가져와 레지스터를 변경한다.
   3. 스택의 꼭대기를 가리키도록 스택 포인터를 변경한다.
   4. 프로그램 카운터가 가리키는 명령어를 실행한다.



### 인터럽트의 발생과 처리 과정

하드웨어가 인터럽트 `A`를 발생시키면, 사용자 모드에 있는 CPU는 현재 상태를 저장하고 커널 모드로 전환한다. **인터럽트 벡터 테이블(interrupt vector table)**에서 인터럽트 `A`를 처리하는 **인터럽트 핸들러(interrupt handler)**를 찾아 실행하여 인터럽트를 처리한다. 인터럽트 핸들러는 **인터럽트 서비스 루틴(Interrupt Service Routine; ISR)**이라고도 한다. 



### 시스템 호출의 발생과 처리 과정

사용자 프로그램이 `A` 시스템 호출을 하면, 사용자 모드에 있는 CPU는 현재 상태를 저장하고 커널 모드로 전환한다. 인터럽트 벡터 테이블에서 `A` 시스템 호출을 처리하는 인터럽트 핸들러를 찾아 실행한다. 이때 핸들러를 **시스템 호출 핸들러(system call handler)** 혹은 시스템 호출 서비스 루틴(system call service routine)이라고도 한다. 핸들러는 시스템 호출 테이블(system call table)에서 `A` 시스템 호출이 구현된 함수를 찾아 `A` 시스템 호출을 실행한다.



## 스터디

1. 인터럽트란 무엇인가?

   CPU에게 특정 이벤트의 발생을 알려 수행 중인 프로그램의 실행을 중단하고 해당 이벤트를 처리하도록 요청하는 것이다.

   1. 인터럽트가 발생하고 처리되는 과정에 대해 말해보세요.

      하드웨어/소프트웨어가 인터럽트 라인을 설정한다. CPU는 현재 명령어를 수행한 후 다음 명령어를 수행하기 전 인터럽트 라인을 검사하여 인터럽트의 발생을 확인한다. CPU가 상태를 저장하고 커널 모드로 전환한다. 인터럽트 벡터 테이블에서 인터럽트 핸들러를 찾아 실행한다. 저장했던 상태를 복구하고 사용자 모드로 전환하여 다음 명령어를 실행한다.



### 인터럽트 서비스 루틴 실행 중 다른 인터럽트가 걸리면 어떻게 할까?

인터럽트의 우선 순위에 따라서 다른 인터럽트를 수행할지 말지 결정한다. (TODO) Interrupt-driven I/O의 다중 인터럽트, 데이지 체인, 폴링



## 참고

[chowisely - Interrupt & System Call](https://velog.io/@chowisely/Operating-Systems-Interrupt-System-Call)

[joona - Interrupt](https://jooona.tistory.com/3)

운영체제 강의 필기
